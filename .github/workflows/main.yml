name: 'Custom Assembly'
on: [push, pull_request]
jobs:
  assembly:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Assemble
        run: |
          zip -r9 cambridge.love libs load res scene tetris conf.lua main.lua scene.lua funcs.lua threaded_replay_code.lua -x "res/img/rpc/*" res/bgm/pacer_test.mp3
          [! -d "dist"] && mkdir dist
          [! -d "dist/windows/"] && mkdir dist/windows
          [! -d "dist/win32/"] && mkdir dist/win32
          cat dist/windows/love.exe cambridge.love > dist/windows/cambridge.exe
          cat dist/win32/love.exe cambridge.love > dist/win32/cambridge.exe
          cp -t dist/windows/ SOURCES.md LICENSE.md
          cp -t dist/win32/ SOURCES.md LICENSE.md
      - name: Upload Windows 32-bit artifact
        uses: actions/upload-artifact@v3
        with:
          name: cambridge_windows_x86
          path: |
            dist/win32/*
            !dist/win32/love.exe
      - name: Upload Windows 64-bit artifact
        uses: actions/upload-artifact@v3
        with:
          name: cambridge_windows_x64
          path: |
            dist/windows/*
            !dist/windows/love.exe
      - name: Upload other OS artifact
        uses: actions/upload-artifact@v3
        with:
          name: cambridge_other
          path: |
            cambridge.love
            libs/discord-rpc.*
            SOURCES.md
            LICENSE.md
      - name: "Cleanup"
        run: |
          rm -f cambridge.love
          rm -f dist/windows/cambridge.exe
          rm -f dist/windows/SOURCES.md
          rm -f dist/windows/LICENSE.md
          rm -f dist/win32/cambridge.exe
          rm -f dist/win32/SOURCES.md
          rm -f dist/win32/LICENSE.md
      